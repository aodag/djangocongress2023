#+TITLE: django migrationで学ぶデータベース設計
#+AUTHOR: Atsushi Odagiri
#+DATE: 2023-10-07
#+BEAMER_THEME: Madrid
#+BEAMER_COLOR_THEME: beetle
#+OPTIONS: H:2 toc:t num:t
#+OPTIONS: ^:{}
#+LaTeX_CLASS: beamer
#+LaTeX_HEADER: \usepackage{luatexja}
#+COLUMNS: %45ITEM %10BEAMER_ENV(Env) %10BEAMER_ACT(Act) %4BEAMER_COL(Col)

* django migrationで学ぶデータベース設計

** はじめに
djangoにはmigrationというデータベーススキーマの変更を管理するツールがあります。
非常にありがたい存在のdjango migrationがやってくれることを今一度確認してみましょう。
データベース設計やオブジェクト指向設計などの面から安全で影響の少ないテーブル変更を考えてみましょう。

** お前誰よ

- aodag
- Atsushi ODAGiri
- 株式会社オープンコレクター
- python ... 1.5 くらい
- django ... 0.96とかsvnのリビジョンで安定してるやつとか

* スキーママイグレーション
** スキーマの構成要素
- table
- column
- index
- constraints
  - null
  - foreign key
  - unique
** スキーマの操作
- alter table
- add column
- drop column
- rename
- modify column
- drop constraints
** django migrate
- makemigrations
- migrate
- sqlmigrate
- showmigrations
** sqlmigrate
** 複数のdjango appにまたがってdowngradeする
- 人類に制御しきれるのか？
** 小さいことはいいことだ
- オブジェクト指向の最小インターフェイス
- テーブル物理設計 小さいテーブルはキャッシュされやすい
- ORMは全カラムをselectしがち 転送量が少ない
- マイグレーション 小さいテーブルの変更はコストが低い
** 小さくする
- 構造に着目 正規化
- ライフサイクルに着目 ユースケース
* 論理設計
** 現実するもののデータ
- マスタ
- エンティティ
- 人モノコト金
** 発生するデータ
- イベント
- トランザクション
- 申込み決済
** 補助的なデータ
- サマリー
- 集計
* 物理設計
** 正規化しろ
- 正規化はmigrationにも効く
** データベース設計と正規化
- なぜ正規化するか
- 正規化の目的
** 正規化の方法
- 第一正規化
- 第二正規化
- 第三正規化
** 第一正規化
- 繰り返しの排除
** 第二正規化
- 部分関数従属性

#+begin_quote
主キーが複数あるテーブルにおいて、そのうちの一部のキーだけで決定できる項目がある場合が部分関数従属です。
#+end_quote

** 第三正規化
- 推移関数従属性

#+begin_quote
推移関数従属性とは、テーブル内の一部の項目がキーでない項目によって決定されることです。
#+end_quote

** 残りを正規化

第四正規形・第五正規形編

** 正規化の効果
- データ空間効率
- 依存関係とスキーママイグレーション
  
** モデル設計と正規化

** 列挙型
- https://www.postgresql.jp/docs/9.2/datatype-enum.html
- https://dev.mysql.com/doc/refman/8.0/ja/enum.html
- あんまりよくない？
** django.db.models.TextChoices, IntegerChoices
- アプリケーションに依存
** 参照テーブル
- データがスキーマ定義に必要
- マイグレーションにデータ操作が入り込む
* django apps
** モデルと機能
- モデルの置き場所
- 機能(views)の置き場所
** アクター、ユースケースの違いで分ける
- アクター、ユースケースの違い = ライフサイクルの違い
- 別の人が情報を追加する = 別のユースケース
- 正規化では見つけられないかも？
- ユースケースごとにdjango appを作る
** 行単位のライフサイクル
- INSERT,UPDATE,DELETE
** カラム単位のライフサイクル
- カラムがNULLじゃなくなるとき
- カラムがNULLになるとき
** UserCredentialとUserProfileを同じモデルにするな
- 認証時にプロフィールは必要ない
- プロフィールを参照するときにパスワードは必要ない
** データの管理
- データフィクスチャ
- migrationでデータ投入は是か非か
* django ORMとオブジェクト指向
** オブジェクト指向との折り合い
- インターフェイス最小の原則
  - テーブルも小さく
  - SELECTを少なく
** だめだと思うところ
- DBをただのオブジェクト保管庫だと思ってそう
- そのわりにはクラス構造がテーブルにひっぱられる
- RDBMSの制限だけ受けていいところを使えない（使いにくい）
** もっとデータベースを知ってモデル設計しましょう
- テーブル設計
  - 正規化
- オブジェクト指向
  - ユースケース

